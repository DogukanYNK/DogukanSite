@page
@model DogukanSite.Pages.Account.TwoFactorAuthenticationPageModel
@{
    ViewData["Title"] = "İki Aşamalı Doğrulama (2FA)";
    Layout = "_AuthLayout";
}

<div class="container my-lg-5 my-4">
    <div class="page-header text-center mb-4">
        <h1 class="page-title display-5">@ViewData["Title"]</h1>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-9">
            <div class="card shadow-sm border-0 rounded-lg">
                <div class="card-body p-4 p-md-5">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="list-group dashboard-nav">
                                <a asp-page="/Account/Dashboard" class="list-group-item list-group-item-action">
                                    <i class="fas fa-arrow-left me-2"></i>Hesabıma Dön
                                </a>
                                <a asp-page="/Account/EditProfile" class="list-group-item list-group-item-action">
                                    <i class="fas fa-user-edit me-2"></i>Profilimi Düzenle
                                </a>
                                <a asp-page="/Account/ChangePasswordPage" class="list-group-item list-group-item-action">
                                    <i class="fas fa-key me-2"></i>Şifre Değiştir
                                </a>
                                <a asp-page="/Account/EmailManagementPage" class="list-group-item list-group-item-action">
                                    <i class="fas fa-envelope me-2"></i>E-posta Yönetimi
                                </a>
                                <a asp-page="/Account/TwoFactorAuthenticationPage" class="list-group-item list-group-item-action active"> @* Bu sayfa aktif *@
                                    <i class="fas fa-shield-alt me-2"></i>İki Aşamalı Doğrulama
                                </a>
                                @* Diğer özel yönetim sayfalarınıza linkler *@
                            </div>
                        </div>

                        <div class="col-md-8">
                            @if (!string.IsNullOrEmpty(Model.StatusMessage))
                            {
                                var statusMessageClass = Model.StatusMessage.StartsWith("Hata:") ? "danger" : "success";
                                <div class="alert alert-@statusMessageClass alert-dismissible fade show" role="alert">
                                    @Model.StatusMessage
                                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                                </div>
                            }

                            <h4 class="mb-3">Doğrulama Uygulaması (Authenticator)</h4>
                            <hr class="my-3">

                            @if (Model.Is2faEnabled)
                            {
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-1"></i> İki aşamalı doğrulama (2FA) şu anda <strong>etkin</strong>.
                                </div>

                                if (Model.RecoveryCodesLeft == 0)
                                {
                                    <div class="alert alert-danger">
                                        <strong>Hiç kurtarma kodunuz kalmadı.</strong> Eğer telefonunuza erişiminizi kaybederseniz hesabınıza erişemeyebilirsiniz. Yeni kurtarma kodları oluşturmalısınız.
                                    </div>
                                    <a asp-page="./GenerateRecoveryCodesPage" class="btn btn-danger mb-3">
                                        <i class="fas fa-exclamation-triangle me-2"></i>Yeni Kurtarma Kodları Oluştur
                                    </a>
                                }
                                else if (Model.RecoveryCodesLeft == 1)
                                {
                                    <div class="alert alert-warning">
                                        Sadece <strong>1</strong> adet kurtarma kodunuz kaldı. Yeni kodlar oluşturmayı düşünebilirsiniz.
                                    </div>
                                    <a asp-page="./GenerateRecoveryCodesPage" class="btn btn-warning mb-3">
                                        <i class="fas fa-sync-alt me-2"></i>Yeni Kurtarma Kodları Oluştur
                                    </a>
                                }
                                else if (Model.RecoveryCodesLeft < 5) // Örnek bir eşik
                                {
                                     <p class="text-muted small">@Model.RecoveryCodesLeft adet kurtarma kodunuz kaldı.</p>
                                     <a asp-page="./GenerateRecoveryCodesPage" class="btn btn-outline-secondary btn-sm mb-3">
                                        <i class="fas fa-sync-alt me-2"></i>Kurtarma Kodlarını Yönet
                                     </a>
                                }
                                else
                                {
                                    <p class="text-muted small">@Model.RecoveryCodesLeft adet kurtarma kodunuz mevcut.</p>
                                     <a asp-page="./GenerateRecoveryCodesPage" class="btn btn-outline-secondary btn-sm mb-3">
                                        <i class="fas fa-sync-alt me-2"></i>Kurtarma Kodlarını Yönet
                                     </a>
                                }

                                <form method="post" asp-page-handler="ForgetClient" class="d-inline">
                                    <button type="submit" class="btn btn-outline-info btn-sm mb-3 @(Model.IsMachineRemembered ? "" : "disabled")" 
                                            title="Bu tarayıcının 2FA için hatırlanmasını kaldırır." @(Model.IsMachineRemembered ? "" : "disabled")>
                                        <i class="fas fa-desktop me-2"></i>Bu Tarayıcıyı Unut
                                    </button>
                                </form>
                                <br />
                                <a asp-page="./Disable2faPage" class="btn btn-danger btn-sm">
                                    <i class="fas fa-times-circle me-2"></i>2FA'yı Devre Dışı Bırak
                                </a>
                            }
                            else if (Model.HasAuthenticator) // Authenticator kurulmuş ama 2FA henüz tam aktif değilse (örn: kod onayı bekliyorsa)
                            {
                                <p class="text-muted">Authenticator uygulamanız ayarlandı.</p>
                                <a asp-page="./EnableAuthenticatorPage" class="btn btn-primary">
                                     <i class="fas fa-cogs me-2"></i>Authenticator Uygulamasını Yapılandır/Doğrula
                                </a>
                                <a asp-page="./ResetAuthenticatorPage" class="btn btn-outline-warning ms-2">Authenticator Anahtarını Sıfırla</a>
                            }
                            else // Hiçbir 2FA yöntemi ayarlanmamış
                            {
                                <p class="text-muted">Hesap güvenliğinizi artırmak için bir doğrulama uygulaması ayarlayabilirsiniz.</p>
                                <a asp-page="./EnableAuthenticatorPage" id="enable-authenticator" class="btn btn-primary">
                                    <i class="fas fa-mobile-alt me-2"></i>Doğrulama Uygulaması Ekle
                                </a>
                            }

                            @* Yeni üretilen kurtarma kodlarını gösterme alanı *@
                            @if (Model.RecoveryCodes?.Length > 0)
                            {
                                <div class="alert alert-info mt-4" role="alert">
                                    <h5 class="alert-heading">Yeni Kurtarma Kodlarınız</h5>
                                    <p>Bu kodları güvenli bir yerde saklayın. Her biri sadece bir kez kullanılabilir.</p>
                                    <div class="row">
                                        @for (var i = 0; i < Model.RecoveryCodes.Length; i += 2)
                                        {
                                            <div class="col-md-6">
                                                <code>@Model.RecoveryCodes[i]</code>
                                                @if (i + 1 < Model.RecoveryCodes.Length)
                                                {
                                                    <br />

                                                    <code>@Model.RecoveryCodes[i + 1]</code>
                                                }
                                            </div>
                                        }
                                    </div>
                                    <hr>
                                    <p class="mb-0"><small>Telefonunuza erişiminizi kaybederseniz bu kodlarla hesabınıza erişebilirsiniz.</small></p>
                                </div>
                                TempData.Remove("RecoveryCodesGenerated");
                            }

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}